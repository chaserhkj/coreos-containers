FROM scratch as dep-files

ADD https://raw.githubusercontent.com/comfyanonymous/ComfyUI/refs/heads/master/requirements.txt /comfyui-deps.txt

ADD https://raw.githubusercontent.com/Comfy-Org/ComfyUI-Manager/refs/heads/main/requirements.txt /comfyui-manager-deps.txt

COPY torch.txt /torch.txt

FROM ghcr.io/astral-sh/uv:python3.12-trixie
ARG TORCH_BACKEND=nightly/rocm7.1

RUN uv venv /venv

ENV VIRTUAL_ENV=/venv

ENV TORCH_BACKEND=${TORCH_BACKEND}

RUN --mount=type=cache,target=/root/.cache/uv,id=uv \
    --mount=from=dep-files,target=/mnt/dep-files \
    uv pip install -r /mnt/dep-files/torch.txt \
        -i https://download.pytorch.org/whl/${TORCH_BACKEND} && \
    uv pip install -r /mnt/dep-files/comfyui-deps.txt \
        --excludes /mnt/dep-files/torch.txt && \
    uv pip install -r /mnt/dep-files/comfyui-manager-deps.txt \
        --excludes /mnt/dep-files/torch.txt

# If on cuda, install cuda SDK, mainly for compiling dependencies for custom nodes
RUN --mount=type=bind,dst=/mnt bash /mnt/install-cuda.sh

# For ComfyUI-Manager to manage custom nodes dependencies
RUN --mount=type=cache,target=/root/.cache/uv,id=uv \
    uv pip install pip uv

# tini Init proxy
RUN --mount=type=cache,target=/var/cache/apt,id=apt \
    apt-get update && apt-get install -y tini

ENV HOME=/app

ENTRYPOINT ["tini", "--"]

CMD ["/app/entrypoint.sh"]

EXPOSE 8188/tcp