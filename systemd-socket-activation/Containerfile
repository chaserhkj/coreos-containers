# Add systemd socket activation capability base image
ARG BASE
# Build deps: latest socat, tini and nc, in static linkage
FROM alpine as build
ARG SOCAT_VERSION=1.8.0.3
ARG SOCAT_SHA256=a9f9eb6cfb9aa6b1b4b8fe260edbac3f2c743f294db1e362b932eb3feca37ba4

RUN --mount=type=cache,target=/var/cache/apk,id=apk \
    apk add gcc g++ coreutils automake make cmake

ENV LDFLAGS=-static

ADD --checksum=sha256:${SOCAT_SHA256} \
    http://www.dest-unreach.org/socat/download/socat-${SOCAT_VERSION}.tar.gz /build-socat/src.tar.gz

RUN cd /build-socat && tar -xf src.tar.gz && cd socat-${SOCAT_VERSION} && \
    ./configure --prefix=/usr/local && make && make install

ADD https://github.com/krallin/tini/archive/refs/heads/master.zip /build-tini/src.zip

RUN cd /build-tini && unzip src.zip && cd tini-master && \
    cmake -S . -B build && cmake --build build --target install

FROM ${BASE}
ARG BASE_CMD
ARG FWD_ADDR=127.8.8.1
ARG FWD_PORT=8000
ARG FWD_PROTO=TCP
ARG POLL_INT=1

# Install utils
COPY --chmod=0755 --from=build /usr/local/bin/socat /usr/local/bin/tini /usr/local/bin

ENV SD_SOCK_ACT_BASE_CMD="${BASE_CMD}" \
    SD_SOCK_ACT_FWD_ADDR="${FWD_ADDR}" \
    SD_SOCK_ACT_FWD_PORT="${FWD_PORT}" \
    SD_SOCK_ACT_FWD_PROTO="${FWD_PROTO}" \
    SD_SOCK_ACT_POLL_INT="${POLL_INT}"

COPY --chmod=0755 entrypoint-sd-sock-act.sh /

ENTRYPOINT ["tini", "--", "/entrypoint-sd-sock-act.sh"]
CMD []