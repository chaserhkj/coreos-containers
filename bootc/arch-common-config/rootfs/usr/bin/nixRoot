#!/bin/bash
[[ "$UID" == "0" ]] || { echo "Must run as root"; exit 1; }

ROOT_STORE=/var/nixRoot/nix
ROOT_PROFILE_BASE=/nix/rootProfile
ROOT_PROFILE=$ROOT_PROFILE_BASE/default

if [[ "$1" != "_unshared" ]]; then
    exec unshare -m -- $0 _unshared "$@"
fi

if [[ "$2" != "_mounted" ]]; then
    shift # "_unshared"
    mkdir -p $ROOT_STORE
    mount --make-private --make-unbindable --bind $ROOT_STORE /nix
    exec $0 _unshared _mounted "$@"
fi

shift 2 # "_unshared _mounted"

export PATH=$ROOT_PROFILE/bin:$PATH

if [[ -z "$1" ]]; then
    exec $SHELL
fi

if [[ "$1" == exec ]] ; then
    shift
    [ -z "$1" ] || exec $SHELL
    exec "$@"
fi

if command -v nix &> /dev/null; then
    NIX=nix
elif command -v nixStatic &> /dev/null; then
    NIX=nixStatic
fi

if [[ "$1" == profile ]]; then
    shift
    op=$1
    shift
    mkdir -p $ROOT_PROFILE_BASE
    exec $NIX profile $op --profile $ROOT_PROFILE "$@"
fi

exec $NIX "$@"